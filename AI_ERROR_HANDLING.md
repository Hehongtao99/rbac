# AI题目提取错误处理说明

## 常见错误类型及解决方案

### 1. JSON解析错误（最常见）

**错误现象：**
```
解析AI响应失败: Unexpected end-of-input within/between Object entries
```

**原因：**
- 输入内容过长，超过AI模型的输出token限制
- AI响应被强制截断，导致JSON格式不完整

**解决方案：**
1. **使用流式解析功能**（推荐）
   - 点击"开始智能提取"按钮
   - 系统会自动分段处理长内容
   - 支持断点续传，可以从中断处继续解析

2. **减少输入内容长度**
   - 将长文本分成多个较短的段落
   - 每次处理不超过8000字符的内容

3. **优化内容格式**
   - 确保题目格式规范
   - 移除不必要的空行和格式符号

### 2. 网络超时错误

**错误现象：**
```
AI服务响应超时，请稍后重试
```

**解决方案：**
- 检查网络连接
- 等待片刻后重试
- 使用流式解析功能，支持断点续传

### 3. 连接错误

**错误现象：**
```
网络连接异常，请检查网络后重试
```

**解决方案：**
- 检查网络连接状态
- 确认防火墙设置
- 重新尝试连接

## 容错机制

### 1. 自动JSON修复
系统会自动尝试修复不完整的JSON响应：
- 检测JSON结构完整性
- 提取完整的题目对象
- 忽略不完整的数据

### 2. 部分数据提取
当JSON完全无法解析时，系统会：
- 逐个解析JSON对象
- 提取所有可解析的完整题目
- 返回部分结果而不是完全失败

### 3. 智能错误提示
根据错误类型提供具体的解决建议：
- 解析错误 → 建议使用流式解析
- 超时错误 → 建议重试或继续解析
- 连接错误 → 建议检查网络

## 最佳实践

### 1. 内容准备
- **格式规范**：确保题目、选项、答案格式清晰
- **长度控制**：单次输入建议不超过20000字符
- **结构清晰**：每道题目之间有明确分隔

### 2. 使用建议
- **长内容**：优先使用流式解析功能
- **短内容**：可以使用直接提取功能
- **重要数据**：建议先预览再添加到题库

### 3. 错误处理
- **遇到错误**：查看具体错误信息
- **解析失败**：切换到流式解析模式
- **网络问题**：检查连接后重试

## 技术实现

### 1. JSON修复算法
```java
private String fixIncompleteJson(String json) {
    // 检查JSON完整性
    // 找到最后一个完整对象
    // 修复JSON结构
}
```

### 2. 部分提取算法
```java
private List<AiExtractedQuestion> extractPartialQuestions(String response) {
    // 逐个解析JSON对象
    // 提取完整的题目数据
    // 忽略不完整的对象
}
```

### 3. 流式处理机制
- **分段大小**：8000字符避免token限制
- **智能分割**：在题目边界分割
- **断点续传**：支持从任意位置继续

## 监控和日志

系统会记录以下信息：
- AI响应内容（用于调试）
- 解析错误详情
- 部分提取结果统计
- 用户操作轨迹

通过这些信息可以：
- 分析错误原因
- 优化解析算法
- 改进用户体验 