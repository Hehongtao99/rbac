# 班级课程表共享功能说明

## 功能概述

班级课程表共享功能允许多个教师为同一个班级添加课程，所有有权限的教师都能看到该班级的完整课程表，包括其他教师添加的课程。

## 核心特性

### 1. 班级课程表共享
- **多教师协作**：多个教师可以为同一个班级添加不同的课程
- **统一视图**：所有有权限的教师都能看到班级的完整课程表
- **实时同步**：一个教师添加课程后，其他教师立即可见

### 2. 权限控制与课程区分
- **班级权限验证**：只有被分配到该班级的教师才能查看和操作该班级的课程表
- **课程所有权区分**：
  - **自己的课程**：正常颜色显示，可以编辑、删除、拖拽移动
  - **其他教师的课程**：灰色显示，只能查看详情，不能编辑、删除或拖拽
- **视觉区分**：
  - 自己的课程：正常颜色，有操作按钮和拖拽手柄
  - 其他教师的课程：灰色背景，显示锁定图标，无操作按钮

### 3. 时间冲突检查
- **教师冲突**：检查教师在同一时间段是否已有其他课程
- **班级冲突**：检查班级在同一时间段是否已有其他课程（防止时间冲突）

### 4. 交互功能
- **课程查看**：点击任何课程（包括其他教师的）都可以查看详情
- **权限提示**：查看其他教师课程时会显示"只读"提示
- **操作限制**：尝试操作其他教师课程时会显示权限提示

## 技术实现

### 后端实现

#### 1. 数据库设计
```sql
-- 课程表表结构
CREATE TABLE `sys_schedule` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `course_id` bigint NOT NULL COMMENT '课程ID',
  `teacher_id` bigint NOT NULL COMMENT '教师ID',
  `teacher_name` varchar(50) NOT NULL COMMENT '教师姓名',
  `class_id` bigint NULL COMMENT '班级ID',
  `class_name` varchar(100) NULL COMMENT '班级名称',
  `academic_year` varchar(20) NOT NULL COMMENT '学年',
  `week_number` int NOT NULL COMMENT '第几周',
  `day_of_week` int NOT NULL COMMENT '星期几',
  `time_slot` int NOT NULL COMMENT '时间段',
  `time_range` varchar(20) NULL COMMENT '时间范围',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `update_time` datetime NOT NULL COMMENT '更新时间',
  `deleted` int DEFAULT 0 COMMENT '删除标记'
);
```

#### 2. 核心API接口

**获取班级课程表（共享）**
```java
@GetMapping("/weekly/class")
public Result<Map<String, List<ScheduleVO>>> getWeeklyScheduleByClass(
    @RequestParam String academicYear,
    @RequestParam Integer weekNumber,
    @RequestParam(required = false) Long classId
) {
    // 如果指定了班级ID，返回该班级的所有课程（所有教师添加的）
    // 如果没有指定班级ID，返回该教师有权限的所有班级的课程
    return Result.success(scheduleService.getWeeklyScheduleByClass(academicYear, weekNumber, classId));
}
```

**权限验证**
```java
// 验证教师是否有权限查看指定班级
if (!teacherClassService.hasClassPermission(teacherId, classId)) {
    throw new RuntimeException("您没有权限查看该班级的课程表");
}
```

**时间冲突检查**
```java
// 检查教师时间冲突
List<Schedule> teacherConflicts = scheduleMapper.selectConflict(teacherId, weekNumber, dayOfWeek, timeSlot);

// 检查班级时间冲突
List<Schedule> classConflicts = scheduleMapper.selectClassTimeConflict(classId, academicYear, weekNumber, dayOfWeek, timeSlot);
```

### 前端实现

#### 1. 用户身份识别
```javascript
// 获取当前用户信息
async getCurrentUserInfo() {
  const userInfo = localStorage.getItem('userInfo')
  if (userInfo) {
    const user = JSON.parse(userInfo)
    this.currentUserId = user.id
  }
}

// 检查课程是否属于当前用户
isCurrentUserCourse(course) {
  return course && course.teacherId === this.currentUserId
}
```

#### 2. 课程显示区分
```vue
<!-- 根据课程所有权显示不同样式 -->
<div class="course-content"
     :class="{ 'other-teacher-course': !isCurrentUserCourse(course) }"
     :draggable="isCurrentUserCourse(course)">
  
  <!-- 只有自己的课程才显示操作按钮 -->
  <div v-if="isCurrentUserCourse(course)" class="course-actions">
    <el-button @click="editCourse(course)">编辑</el-button>
    <el-button @click="removeCourse(course)">删除</el-button>
  </div>
  
  <!-- 其他教师的课程显示只读标识 -->
  <div v-if="!isCurrentUserCourse(course)" class="readonly-indicator">
    <el-icon><Lock /></el-icon>
  </div>
</div>
```

#### 3. 权限控制
```javascript
// 拖拽权限检查
handleDragStart(event, course) {
  if (!this.isCurrentUserCourse(course)) {
    event.preventDefault()
    ElMessage.warning('只能拖拽自己的课程')
    return
  }
}

// 删除权限检查
async removeCourse(course) {
  if (!this.isCurrentUserCourse(course)) {
    ElMessage.warning('您只能删除自己的课程')
    return
  }
}
```

#### 4. 样式区分
```css
/* 其他教师的课程样式 */
.other-teacher-course {
  background-color: #f5f5f5 !important;
  opacity: 0.7;
  cursor: pointer !important;
}

.other-teacher-course .course-name {
  color: #909399 !important;
}

.other-teacher-course .course-teacher,
.other-teacher-course .course-class {
  color: #c0c4cc !important;
}
```

## 使用场景示例

### 场景1：多教师协作
1. **张老师**为"软工2021级1班"添加"Web开发实践"课程（周一第2节）
2. **李老师**为"软工2021级1班"添加"数据库原理"课程（周二第3节）
3. **王老师**查看"软工2021级1班"课程表时，可以看到：
   - 张老师的"Web开发实践"（灰色显示，只读）
   - 李老师的"数据库原理"（灰色显示，只读）
   - 自己的课程（正常显示，可操作）

### 场景2：时间冲突避免
1. **张老师**已为"软工2021级1班"在周一第2节安排了课程
2. **李老师**尝试在同一时间段添加课程时，系统提示"该时间段已有课程安排"
3. **李老师**可以选择其他空闲时间段

### 场景3：课程查看与权限
1. **王老师**点击张老师的课程，弹出"课程详情（只读）"对话框
2. 对话框显示课程信息和权限提示："这是其他教师的课程，您只能查看详情，无法编辑或删除"
3. **王老师**点击自己的课程，可以正常编辑和删除

## 测试数据

数据库中已添加测试数据，演示班级课程表共享功能：

```sql
-- 张老师（ID=5）为软工2021级1班添加Web开发实践课程
INSERT INTO sys_schedule VALUES (27, 7, 'Web开发实践', 5, '张老师', 14, '软工2021级1班', 3, '2024-2025', 1, 1, 2, '10:00-11:40', 1, '2025-06-01 10:00:00', '2025-06-01 10:00:00', 0);

-- 李老师（ID=6）为软工2021级1班添加数据库原理课程  
INSERT INTO sys_schedule VALUES (29, 3, '数据库原理', 6, '李老师', 14, '软工2021级1班', 4, '2024-2025', 1, 2, 3, '16:30-18:10', 1, '2025-06-01 10:00:00', '2025-06-01 10:00:00', 0);
```

## 总结

班级课程表共享功能成功实现了多教师协作的需求，通过权限控制和视觉区分，确保了数据安全性和用户体验。教师可以看到完整的班级课程安排，同时只能操作自己的课程，有效避免了误操作和权限混乱。 