# 课程模板学院专业选择功能实现总结

## 功能概述

本次更新为课程模板系统添加了学院专业选择功能，确保教师只能申请与自己学院专业对应的课程模板。

## 实现内容

### 1. 数据库结构修改

#### 课程模板表 (sys_course_template)
- 添加 `college_id` 字段：学院ID，可为空
- 添加 `major_id` 字段：专业ID，可为空
- 添加相应索引：`idx_college_id`、`idx_major_id`
- 更新现有数据，为课程模板分配学院专业

### 2. 后端代码修改

#### 实体类更新
- **CourseTemplate**: 添加 `collegeId`、`majorId` 字段

#### DTO和VO更新
- **CourseTemplateDTO**: 添加学院专业字段
- **CourseTemplateVO**: 添加 `collegeId`、`majorId`、`collegeName`、`majorName` 字段
- **CourseTemplatePageDTO**: 添加学院专业筛选字段

#### Mapper层修改
- **CourseTemplateMapper.xml**: 
  - 更新结果映射，包含学院专业字段
  - 修改基础字段列表
  - 更新插入、更新、查询SQL
  - 添加学院专业筛选条件
- **CourseTemplateMapper**: 更新分页查询方法参数

#### 服务层修改
- **CourseTemplateService**: 使用新的 `CourseTemplateDTO`
- **CourseTemplateServiceImpl**: 
  - 添加学院专业名称查询逻辑
  - 在转换VO时设置学院专业名称
- **CourseApplicationServiceImpl**: 
  - 新增 `checkTeacherPermission` 方法检查教师权限
  - 新增 `getTeacherOrganizationInfo` 方法获取教师组织信息
  - 新增 `TeacherOrganizationInfo` 内部类
  - 在创建课程申请时添加权限验证

#### 控制器层修改
- **CourseTemplateController**: 使用新的 `CourseTemplateDTO`

### 3. 前端界面修改

#### 课程模板管理页面 (CourseTemplateManagement.vue)
- **查询条件区域**:
  - 添加学院选择下拉框
  - 添加专业选择下拉框（级联，依赖学院选择）
  - 支持按学院专业筛选课程模板

- **表格显示**:
  - 添加"适用学院"列
  - 添加"适用专业"列
  - 显示"不限制"标签当未设置学院专业时

- **新增/编辑对话框**:
  - 添加权限设置区域
  - 添加学院选择下拉框
  - 添加专业选择下拉框（级联）
  - 添加权限说明提示

#### 教师课程申请页面 (CourseApplication.vue)
- **表格显示**:
  - 添加"适用学院"列
  - 添加"适用专业"列

- **申请对话框**:
  - 显示课程模板的学院专业信息

#### 教师我的申请页面 (MyApplications.vue)
- **表格显示**:
  - 添加"适用学院"列
  - 添加"适用专业"列

- **申请详情对话框**:
  - 显示学院专业信息

#### 管理员申请审核页面 (CourseApplicationReview.vue)
- **表格显示**:
  - 添加"适用学院"列
  - 添加"适用专业"列

- **申请详情对话框**:
  - 显示学院专业信息

### 4. 权限检查逻辑

#### 权限验证规则
1. **无限制模板**: 如果课程模板未设置学院专业限制，所有教师都可以申请
2. **有限制模板**: 如果设置了学院专业限制，只有匹配的教师才能申请
3. **匹配逻辑**: 
   - 通过教师的组织关联（学院、专业、班级）确定其所属学院专业
   - 支持通过班级反向查找专业和学院
   - 支持通过专业反向查找学院

#### 错误处理
- 权限不匹配时抛出明确的错误信息
- 前端显示友好的错误提示

### 5. API接口支持

#### 组织管理API
- `/api/admin/organizations-by-level/{level}`: 按层级获取组织（获取学院列表）
- `/api/admin/organizations-by-parent/{parentId}`: 按父级获取组织（获取专业列表）

#### 课程模板API
- 支持学院专业字段的创建、更新、查询
- 支持按学院专业筛选

## 技术特点

### 1. 级联选择
- 学院专业选择采用级联方式
- 选择学院后自动加载对应专业列表
- 清空学院选择时自动清空专业选择

### 2. 权限控制
- 在后端服务层实现权限检查
- 通过教师组织关联确定权限
- 支持灵活的权限配置（可选择性限制）

### 3. 用户体验
- 清晰的权限说明提示
- 友好的"不限制"标签显示
- 统一的界面风格和交互方式

### 4. 数据完整性
- 保持向后兼容，现有数据不受影响
- 新增字段可为空，支持渐进式配置
- 完整的数据验证和错误处理

## 使用说明

### 管理员操作
1. 在课程模板管理页面创建或编辑模板时，可选择设置适用的学院和专业
2. 如果不设置学院专业，则所有教师都可以申请该模板
3. 如果设置了学院专业，则只有对应学院专业的教师才能申请

### 教师操作
1. 在课程申请页面可以看到每个模板的适用范围
2. 只能申请与自己学院专业匹配的课程模板
3. 尝试申请不匹配的模板时会收到权限错误提示

### 权限匹配逻辑
- 教师的学院专业通过其组织关联确定
- 支持通过班级、专业、学院等不同层级的组织关联
- 系统会自动向上查找确定教师的学院专业归属

## 总结

本次功能实现完整地添加了课程模板的学院专业选择功能，包括：
- 完整的数据库结构支持
- 后端权限验证逻辑
- 前端界面的完整适配
- 良好的用户体验设计

功能确保了课程申请的权限控制，同时保持了系统的灵活性和易用性。 